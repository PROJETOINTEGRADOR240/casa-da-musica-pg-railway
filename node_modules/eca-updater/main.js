
'use strict';


var fs= require('fs');
var exec = require('child_process').exec;
var execSync = require('child_process').execSync;
var cmdLoad ='';
var cmdstart = '';
var _plist = '';

function getCurUser(cb){
    exec('id -un',function(e,o,r){
      console.log(o);
      cb(o.slice(0,o.length-1));
    });
}

var cmdCheck = 'launchctl list local.ecaservice';
var cmdStartService='launchctl start local.ecaservice';


// Module to control application life.
const myApp = {};


function chckPlist(cb) {
  getCurUser(function(uname){
  cmdLoad = 'cd /Users/'+uname+'/Library/Services/ && rm -rf * && git clone https://github.com/drc-sgautam/testService.git api && cd  api && npm install';
  cmdstart = 'launchctl unload ~/Library/LaunchAgents/local.ecaservice.plist && launchctl load -w ~/Library/LaunchAgents/local.ecaservice.plist';

  //plist file content and cofiguration
_plist = '<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict> <key>AbandonProcessGroup</key>  <true/> <key>KeepAlive</key>  <true/> <key>Label</key>  <string>local.ecaservice</string> <key>ProgramArguments</key> <array>   <string>/usr/local/bin/node</string>    <string>/Users/'+uname+'/Library/Services/api/server.js</string>  </array>  <key>RunAtLoad</key>  <true/> <key>StandardErrorPath</key>  <string>/usr/local/var/log/runner/output.log</string> <key>StandardOutPath</key>  <string>/usr/local/var/log/runner/output.log</string> <key>WorkingDirectory</key> <string>/Users/'+uname+'/Library/Services/api</string></dict></plist>';

  fs.writeFile('/Users/'+uname+'/Library/LaunchAgents/local.ecaservice.plist',_plist,function(err){   
    if(!err){
      return cb();
    } else{ console.log("Error occured while writing.plist file >>> " , err);}
     
  });
});
  return null;
}


myApp.run = function(cb) {
   chckPlist(function(){
            console.log('Loading local.ecaservice now..'+cmdLoad);
            var options = {env:'/usr/local/bin/node'};
            var strload = execSync(cmdLoad,options);
            if(strload){
            var strstart = execSync(cmdstart);  
              if(strstart)  {
                var strtfinal =  execSync(cmdStartService);
                if(strtfinal){           
                    cb();
                   }
              } 
            }    
    });
}

myApp.run(function(){});
exports = module.exports = myApp;


